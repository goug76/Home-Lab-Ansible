---
- name: Proxmox Onboarding
  hosts: all

  tasks:
    - name: Remove Proxmox Enterprise repository
      ansible.builtin.lineinfile: 
        path: /etc/apt/sources.list.d/pve-enterprise.list 
        regexp: '^(.*)deb https://enterprise.proxmox.com(.*)$' 
        line: '#deb https://enterprise.proxmox.com/debian/pve bookworm pve-enterprise'
        backrefs: yes

    - name: Remove Proxmox Enterprise Ceph repository
      ansible.builtin.lineinfile: 
        path: /etc/apt/sources.list.d/ceph.list 
        regexp: '^(.*)deb https://enterprise.proxmox.com(.*)$' 
        line: '#deb https://enterprise.proxmox.com/debian/ceph-quincy bookworm enterprise'
        backrefs: yes

    - name: Add Proxmox no-subscription repository
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list
        line: 'deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription'
        state: present
        
    - name: upgrade apt packages
      ansible.builtin.apt:
        upgrade: yes
        update_cache: yes

    - name: Install required system packages
      ansible.builtin.apt:
        pkg:
          - sudo
          - python3-proxmoxer
          - python3-requests
        update_cache: no
        cache_valid_time: 3600
        state: latest
    
    - name: Remove useless packages from the cache
      ansible.builtin.apt:
        autoclean: yes
        
    - name: Remove dependencies that are no longer required and purge their configuration files
      ansible.builtin.apt:
        autoremove: yes
        purge: true

    - name: create user
      ansible.builtin.user:
        name: "{{user}}"
        password: "{{pwd}}"
        groups: sudo
        state: present
        shell: /bin/bash
        system: no
        createhome: yes
        home: /home/{{user}}
    
    - name: add ssh key root
      ansible.posix.authorized_key:
        user: "root"
        key: "{{ssh_key}}"
    
    - name: add ssh key
      ansible.posix.authorized_key:
        user: "{{user}}"
        key: "{{ssh_key}}"
    
    - name: add Ansible ssh key
      ansible.posix.authorized_key:
        user: "{{user}}"
        key: "{{ansible_key}}"

    - name: enable pci pass-thur
      ansible.builtin.lineinfile: 
        path: /etc/default/grub 
        regexp: '^(.*)GRUB_CMDLINE_LINUX_DEFAULT(.*)$' 
        line: 'GRUB_CMDLINE_LINUX_DEFAULT="quiet intel_iommu=on"'
        backrefs: yes

    - name: add kernel modules for pci pass-thru
      ansible.builtin.lineinfile:
        path: /etc/modules
        line: "{{ item.line }}"
        state: present
      loop:
        - line: 'vfio'
        - line: 'vfio_iommu_type1'
        - line: 'vfio_pci'
        - line: 'vfio_virqfd'
        
    - name: remove nag message
      ansible.builtin.replace:
        path: /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
        regexp: "res === null \\|\\| res === undefined \\|\\| \\!res \\|\\| res\\n\\t\\t\\t.data.status.toLowerCase\\(\\) \\!== 'active'"
        replace: "false"
        backup: yes

    - name: Check if reboot required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required_file

    - name: Reboot if required
      ansible.builtin.reboot:
      when: reboot_required_file.stat.exists == true

# Password can't be plain text so run this command to hash it: mkpasswd --method=sha-512